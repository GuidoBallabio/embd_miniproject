#include <iostream>
#include <fstream>
#include <string>
#include "xparameters.h"

#include "./GPIOs/Buttons.h"
#include "./GPIOs/Leds.h"
#include "HWInterrupt.h"

#define BTN_INT 			XGPIO_IR_CH1_MASK

static int led_data;
static int btn_value;
static bool led8On = false;

Buttons btn;
IHWInput& btns = btn;
Leds leds;

XGpio b = btn.getGPIOInstance();
XGpio l = leds.getGPIOInstance();

static void BTN_Intr_Handler(void *InstancePtr)
{
	printf("Hello\r\n");
	// Disable GPIO interrupts
	XGpio_InterruptDisable(&b, BTN_INT);

	// Ignore additional button presses
	if ((XGpio_InterruptGetStatus(&b) & BTN_INT) != BTN_INT) {
			printf("Error\r\n");
		}
	btn_value = XGpio_DiscreteRead(&b, 1);
	// Increment counter based on button value

	if (btn_value == 8)
	{
		if (led8On)
			led_data = 0;
		else
			led_data = 8;

		led8On = !led8On;
		XGpio_DiscreteWrite(&l, 1, led_data);

	}

	//led_data = led_data + btn_value;

	(void)XGpio_InterruptClear(&b, BTN_INT);
    // Enable GPIO interrupts
    XGpio_InterruptEnable(&b, BTN_INT);

}

void interrupt(XGpio gpio, u32 mask, u32 gpioInterruptID, void* interruptHandler)
{
	XScuGic_Config *IntcConfig;
	XScuGic INTCInst;
	int status;

	// Interrupt controller initialisation
	IntcConfig = XScuGic_LookupConfig(XPAR_PS7_SCUGIC_0_DEVICE_ID);
	status = XScuGic_CfgInitialize(&INTCInst, IntcConfig, IntcConfig->CpuBaseAddress);
	if(status != XST_SUCCESS)
		printf("Error 1\r\n");

	// Call to interrupt setup
	// Enable interrupt
	XGpio_InterruptEnable(&gpio, mask);
	XGpio_InterruptGlobalEnable(&gpio);

	Xil_ExceptionRegisterHandler(XIL_EXCEPTION_ID_INT,
								 (Xil_ExceptionHandler)XScuGic_InterruptHandler,
								 &INTCInst);
	Xil_ExceptionEnable();


	// Connect GPIO interrupt to handler
	status = XScuGic_Connect(&INTCInst,
							XPAR_FABRIC_BUTTONS_IP2INTC_IRPT_INTR,
							 (Xil_ExceptionHandler)BTN_Intr_Handler,
							 (void *)&gpio);
	if(status != XST_SUCCESS)
		printf("error 2\r\n");

	// Enable GPIO interrupts interrupt
	XGpio_InterruptEnable(&gpio, 1);
	XGpio_InterruptGlobalEnable(&gpio);

	// Enable GPIO and timer interrupts in the controller
	XScuGic_Enable(&INTCInst, XPAR_FABRIC_BUTTONS_IP2INTC_IRPT_INTR);
}

int main(int, char**)
{
	xil_printf("Starting program\r\n");

	//Initialize GPIOs

	// Initialize interrupt controller
	interrupt(b, BTN_INT, XPAR_FABRIC_BUTTONS_IP2INTC_IRPT_INTR,
			(void*)BTN_Intr_Handler);

	char value = inbyte();
	inbyte(); // CR

	while (value != '1')
	{
		value = inbyte();
		inbyte();
	}



	xil_printf("Exiting program\r\n");

	return 0;
}


