#include <iostream>
#include <fstream>
#include <string>
#include "xparameters.h"

#include "./GPIOs/Buttons.h"
#include "./GPIOs/Leds.h"
#include "HWInterrupt.h"

#define INTC_GPIO_INTERRUPT_ID XPAR_FABRIC_BUTTONS_IP2INTC_IRPT_INTR

#define BTN_INT 			XGPIO_IR_CH1_MASK

static int led_data;
static int btn_value;
static bool led8On = false;

Buttons btn;
IHWInput& btns = btn;
Leds leds;

static void BTN_Intr_Handler()
{
	// Disable GPIO interrupts
	XGpio_InterruptDisable((&)btn.getGPIOInstance(), BTN_INT);
	// Ignore additional button presses
	if ((XGpio_InterruptGetStatus(btn.getGPIOInstance()) & BTN_INT) !=
			BTN_INT) {
			return;
		}
	btn_value = XGpio_DiscreteRead(btn.getGPIOInstance(), 1);
	// Increment counter based on button value

	if (btn_value == 8)
	{
		if (led8On)
			led_data = 0;
		else
			led_data = 8;

		led8On = !led8On;
		XGpio_DiscreteWrite(leds.getGPIOInstance(), 1, led_data);

	}

	//led_data = led_data + btn_value;

	(void)XGpio_InterruptClear(btn.getGPIOInstance(), BTN_INT);
    // Enable GPIO interrupts
    XGpio_InterruptEnable(btn.getGPIOInstance(), BTN_INT);
}

int main(int, char**)
{
	xil_printf("Starting program\r\n");

	//Initialize GPIOs

	// Initialize interrupt controller
	HWInterrupt interrupt(btn, BTN_INT, XPAR_FABRIC_BUTTONS_IP2INTC_IRPT_INTR,
			(BTN_Intr_Handler(btn.getGPIOInstance(), leds.getGPIOInstance())));

	char value = inbyte();
	inbyte(); // CR

	while (value != '1')
	{
		value = inbyte();
		inbyte();
	}



	xil_printf("Exiting program\r\n");

	return 0;
}

